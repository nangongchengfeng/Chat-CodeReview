# chat-review

## åŠŸèƒ½ä»‹ç»

**ChatGPTé›†æˆGitlabï¼Œå®ç°è‡ªåŠ¨ä»£ç å®¡è®¡å¹¶è¿›è¡Œè¯„è®ºï¼Œä¸ºè½¯ä»¶å¼€å‘å›¢é˜Ÿæä¾›é«˜æ•ˆã€æ™ºèƒ½çš„ä»£ç å®¡æŸ¥è§£å†³æ–¹æ¡ˆã€‚**

> 1. è‡ªåŠ¨è§¦å‘ä¸åŠæ—¶å“åº”ï¼šåˆ©ç”¨Gitlabçš„WebhookåŠŸèƒ½ï¼Œå®ç°ä»£ç æäº¤ã€åˆå¹¶è¯·æ±‚å’Œæ ‡ç­¾åˆ›å»ºç­‰äº‹ä»¶çš„è‡ªåŠ¨è§¦å‘ã€‚ä¸€æ—¦æœ‰æ–°çš„ä»£ç æäº¤ï¼Œç³»ç»Ÿå³æ—¶å“åº”ï¼Œç«‹å³å¯åŠ¨å®¡è®¡è¿‡ç¨‹ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚
> 2. åˆ©ç”¨Gitlab APIæ¥å£ï¼šé€šè¿‡ä¸Gitlabçš„APIæ¥å£é›†æˆï¼Œæ–¹ä¾¿åç»­çš„åŠŸèƒ½æ‹“å±•å’Œæ‰©å±•ã€‚è¿™ç§é›†æˆæ–¹å¼ä½¿å¾—ä¸Gitlabçš„äº¤äº’æ›´åŠ çµæ´»ï¼Œèƒ½å¤Ÿæ”¯æŒæ›´å¤šè‡ªå®šä¹‰çš„å®¡è®¡éœ€æ±‚ã€‚
> 3. å…¨é¢è‡ªåŠ¨å®¡è®¡ï¼šChatGPTè‡ªåŠ¨å®¡è®¡Gitlabçš„ä»£ç ï¼Œæ¶µç›–pushï¼ˆcommitï¼‰ã€mergeï¼ˆåˆå¹¶è¯·æ±‚ï¼‰å’Œtagï¼ˆæ ‡ç­¾åˆ›å»ºï¼‰ç­‰ä¸‰ç§ä»£ç æäº¤æ–¹å¼ã€‚æ— è®ºæ˜¯æ–°çš„ä»£ç æäº¤è¿˜æ˜¯ä»£ç åˆå¹¶ï¼Œç³»ç»Ÿéƒ½èƒ½è‡ªåŠ¨æ£€æŸ¥å¹¶æä¾›å®¡è®¡è¯„è®ºã€‚
> 4. retryingé‡è¯•æœºåˆ¶ï¼šä¸ºäº†åº”å¯¹ç½‘ç»œå¼‚å¸¸æˆ–å…¶ä»–é—®é¢˜ï¼Œç³»ç»Ÿå®ç°äº†retryingé‡è¯•æœºåˆ¶ã€‚å¦‚æœå› ä¸ºç½‘ç»œé—®é¢˜å¯¼è‡´è¯·æ±‚ä¸æˆåŠŸï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œé‡è¯•ï¼Œç¡®ä¿å®¡è®¡è¿‡ç¨‹çš„å¯é æ€§å’Œç¨³å®šæ€§ã€‚

## å®¡è®¡åŸç†

![1689647943933](images/1689647943933.png)

 **ä¸‹æ­¥éª¤æ¥å®ç°ï¼š** 

> 1. Gitlabçš„Webhookäº‹ä»¶æ¨é€ï¼š Gitlabå¯ä»¥é…ç½®Webhookï¼Œç”¨äºåœ¨ä»£ç æäº¤ã€åˆå¹¶è¯·æ±‚ç­‰äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘é€šçŸ¥ã€‚å½“æœ‰æ–°çš„ä»£ç æäº¤æˆ–åˆå¹¶è¯·æ±‚æ—¶ï¼ŒGitlabå°†å‘é¢„å…ˆè®¾ç½®çš„URLå‘é€POSTè¯·æ±‚ï¼ŒåŒ…å«ç›¸å…³çš„äº‹ä»¶æ•°æ®ã€‚
> 2. è§£ædiffå†…å®¹å¹¶å‘é€è‡³ChatGPTï¼š å½“Gitlabæ”¶åˆ°Webhookäº‹ä»¶åï¼Œå¯ä»¥è§£ædiffå†…å®¹ï¼Œè¿™æ˜¯æ–°æäº¤çš„ä»£ç ä¸ç°æœ‰ä»£ç ä¹‹é—´çš„å·®å¼‚ã€‚ç„¶åï¼Œå°†è¿™äº›å·®å¼‚å‘é€ç»™ChatGPTçš„APIç«¯ç‚¹ï¼Œä»¥ä¾¿ChatGPTèƒ½å¤Ÿç†è§£ä»£ç å˜æ›´çš„å†…å®¹ã€‚
> 3. ChatGPTå¤„ç†å¹¶è¿”å›ç»“æœï¼š ChatGPTæ˜¯ä¸€ä¸ªå¼ºå¤§çš„è‡ªç„¶è¯­è¨€å¤„ç†æ¨¡å‹ï¼Œèƒ½å¤Ÿç†è§£å’Œå¤„ç†è‡ªç„¶è¯­è¨€æ–‡æœ¬ã€‚å½“ChatGPTæ”¶åˆ°diffå†…å®¹åï¼Œå®ƒä¼šè§£æã€ç†è§£ä»£ç çš„å˜æ›´ï¼Œå¹¶å¯¹å…¶ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜ã€æ¼æ´æˆ–ä¼˜åŒ–å»ºè®®è¿›è¡Œåˆ†æå’Œå›å¤ã€‚ChatGPTå°†å¤„ç†åçš„ç»“æœè¿”å›ç»™è§¦å‘Webhookçš„Gitlabå®ä¾‹ã€‚
> 4. å°†ChatGPTå¤„ç†çš„ç»“æœè¿›è¡Œè¯„è®ºå±•ç¤ºï¼š Gitlabå¯ä»¥æ¥æ”¶æ¥è‡ªChatGPTçš„å¤„ç†ç»“æœï¼Œå¹¶å°†å…¶ä½œä¸ºè¯„è®ºæ·»åŠ åˆ°å¯¹åº”çš„æäº¤æˆ–åˆå¹¶è¯·æ±‚ä¸­ã€‚è¿™æ ·ï¼Œä»£ç æäº¤è€…å’Œå…¶ä»–å›¢é˜Ÿæˆå‘˜éƒ½å¯ä»¥æŸ¥çœ‹ChatGPTçš„å®¡è®¡ç»“æœï¼Œå¹¶æ ¹æ®å»ºè®®åšå‡ºç›¸åº”çš„æ”¹è¿›æˆ–ä¿®å¤ã€‚

 é€šè¿‡å°†Gitlabä»£ç å®¡è®¡ä¸ChatGPTçš„ç»“åˆï¼Œå¯ä»¥å®ç°ä»£ç è´¨é‡çš„è‡ªåŠ¨æ£€æŸ¥å’Œå®¡æŸ¥ï¼Œä»è€Œå¸®åŠ©å›¢é˜Ÿå‘ç°æ½œåœ¨çš„é—®é¢˜ã€æ¼æ´æˆ–æ”¹è¿›æœºä¼š ï¼ˆä»¥ä¸Šä»…ä¾›å‚è€ƒï¼‰





## prompt

### èµ„æ·±é¢†å¯¼

```python
    messages = [
        {"role": "system",
         "content": "ä½ æ˜¯æ˜¯ä¸€ä½èµ„æ·±ç¼–ç¨‹ä¸“å®¶ï¼Œgitlabçš„commitä»£ç å˜æ›´å°†ä»¥git diff å­—ç¬¦ä¸²çš„å½¢å¼æä¾›ï¼Œæ³¨æ„ï¼šä»£ç ä¸­ï¼š- è¡¨ç¤ºåˆ é™¤çš„ä»£ç ï¼Œ+ è¡¨ç¤ºæ–°å¢çš„ä»£ç  # è¡¨ç¤ºä»£ç æ³¨é‡Šï¼Œä»¥æ ¼å¼ã€Œå˜æ›´è¯„åˆ†ï¼šå®é™…çš„åˆ†æ•°ã€ç»™å˜æ›´æ‰“åˆ†ï¼Œåˆ†æ•°åŒºé—´ä¸º0~100åˆ†ã€‚è¾“å‡ºæ ¼å¼ï¼šç„¶åï¼Œä»¥ç²¾ç‚¼çš„è¯­è¨€ã€ä¸¥å‰çš„è¯­æ°”æŒ‡å‡ºå­˜åœ¨çš„é—®é¢˜ã€‚å¦‚æœä½ è§‰å¾—å¿…è¦çš„æƒ…å†µä¸‹ï¼Œå¯ç›´æ¥ç»™å‡ºä¿®æ”¹åçš„å†…å®¹ã€‚ä½ çš„åé¦ˆå†…å®¹å¿…é¡»ä½¿ç”¨ä¸¥è°¨çš„markdownæ ¼å¼ã€‚"
         },
        {"role": "user",
         "content": f"è¯·reviewè¿™éƒ¨åˆ†ä»£ç å˜æ›´{change['diff']}",
         },
    ]
```

### å‚²å¨‡å°‘å¥³ğŸ‘§

æ¥è¯„å®¡ï¼Œå‚è€ƒå¦‚ä¸‹è§’è‰²å£°æ˜ï¼š 

```python
{
    "role": "system",
    "content": "ä½ æ˜¯ä¸€ä¸ªå¤©æ‰å°å¥³å­©ï¼Œç²¾é€šç¼–ç¨‹å·¥ä½œï¼Œæ€§æ ¼å¾ˆå‚²å¨‡åˆé«˜å‚²ï¼Œè´Ÿè´£å¯¹å‰è¾ˆçš„ä»£ç å˜æ›´è¿›è¡Œå®¡æŸ¥ï¼Œç”¨åè¾ˆçš„æ€åº¦ã€æ´»æ³¼è½»å¿«çš„æ–¹å¼çš„æŒ‡å‡ºå­˜åœ¨çš„é—®é¢˜ã€‚ä½¿ç”¨markdownæ ¼å¼ã€‚å¯ä»¥åŒ…å«emojiã€‚"
}
```

## ç¯å¢ƒå˜é‡

> -  gitlab_server_url :  GitlabæœåŠ¡å™¨çš„URLåœ°å€ 
> -  gitlab_private_token :  ç”¨äºè®¿é—®Gitlab APIçš„ç§æœ‰è®¿é—®ä»¤ç‰Œï¼ˆprivate tokenï¼‰ 
> -  openai_api_key :  ç”¨äºè®¿é—®OpenAIçš„APIçš„å¯†é’¥ 



## Gitlabçš„WebHook

Gitlabçš„Webhookæ˜¯ä¸€ç§äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå…è®¸ä½ åœ¨Gitlabä¸­é…ç½®ä¸€ä¸ªURLåœ°å€ï¼Œå½“ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒGitlabä¼šå‘è¯¥URLå‘é€HTTPè¯·æ±‚ï¼Œå°†ç›¸å…³äº‹ä»¶æ•°æ®ä¼ é€’ç»™ä½ çš„åº”ç”¨ç¨‹åºã€‚è¿™æ ·ï¼Œä½ çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥æ ¹æ®è¿™äº›äº‹ä»¶æ•°æ®æ¥æ‰§è¡Œè‡ªå®šä¹‰çš„æ“ä½œæˆ–å“åº”ã€‚

Webhookå¯ç”¨äºåœ¨Gitlabä¸­ç›‘è§†å’Œå“åº”å„ç§äº‹ä»¶ï¼Œä¾‹å¦‚ä»£ç æäº¤ã€åˆå¹¶è¯·æ±‚ã€æ ‡ç­¾åˆ›å»ºã€åˆ†æ”¯æ“ä½œç­‰ã€‚é€šè¿‡åˆ©ç”¨Webhookï¼Œä½ å¯ä»¥å®ç°å„ç§è‡ªåŠ¨åŒ–ä»»åŠ¡ã€é›†æˆå’ŒæŒç»­é›†æˆ/æŒç»­éƒ¨ç½²ï¼ˆCI/CDï¼‰æµç¨‹ã€‚

ä»¥ä¸‹æ˜¯Gitlabçš„Webhookçš„ä¸»è¦ç‰¹ç‚¹å’Œç”¨é€”ï¼š

> 1. äº‹ä»¶è§¦å‘ï¼šå½“ä½ åœ¨Gitlabä¸­é…ç½®Webhookå¹¶å¯ç”¨åï¼Œç‰¹å®šçš„äº‹ä»¶ï¼ˆå¦‚ä»£ç æäº¤ã€åˆå¹¶è¯·æ±‚ç­‰ï¼‰å‘ç”Ÿæ—¶ï¼ŒGitlabä¼šè‡ªåŠ¨è§¦å‘Webhookã€‚
> 2. HTTPè¯·æ±‚ï¼šä¸€æ—¦äº‹ä»¶è§¦å‘ï¼ŒGitlabä¼šå‘ä½ é¢„å…ˆé…ç½®çš„URLå‘é€HTTPè¯·æ±‚ï¼Œå…¶ä¸­åŒ…å«ç›¸å…³äº‹ä»¶çš„æ•°æ®ã€‚é€šå¸¸æ˜¯POSTè¯·æ±‚ï¼Œå¹¶æºå¸¦JSONæ ¼å¼çš„æ•°æ®ã€‚
> 3. è‡ªå®šä¹‰æ“ä½œï¼šé€šè¿‡ç¼–å†™ä¸€ä¸ªæ¥æ”¶Webhookè¯·æ±‚çš„è„šæœ¬æˆ–æœåŠ¡ï¼Œä½ å¯ä»¥è§£æå’Œå¤„ç†æ¥æ”¶åˆ°çš„äº‹ä»¶æ•°æ®ï¼Œæ‰§è¡Œè‡ªå®šä¹‰çš„æ“ä½œï¼Œæ¯”å¦‚è‡ªåŠ¨æ„å»ºã€è‡ªåŠ¨æµ‹è¯•ã€è‡ªåŠ¨éƒ¨ç½²ç­‰ã€‚
> 4. é›†æˆå…¶ä»–æœåŠ¡ï¼šWebhookä½¿å¾—Gitlabèƒ½å¤Ÿä¸å…¶ä»–æœåŠ¡å’Œå·¥å…·è¿›è¡Œé›†æˆï¼Œä¾‹å¦‚è‡ªåŠ¨åŒæ­¥ä»£ç åˆ°æŒç»­é›†æˆå¹³å°ã€è‡ªåŠ¨é€šçŸ¥å›¢é˜Ÿæˆå‘˜ã€è‡ªåŠ¨æ›´æ–°ä»»åŠ¡è·Ÿè¸ªç³»ç»Ÿç­‰ã€‚
> 5. å¯é…ç½®æ€§ï¼šGitlabçš„Webhookå…·æœ‰ä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼Œä½ å¯ä»¥é€‰æ‹©è¦ç›‘è§†çš„äº‹ä»¶ç±»å‹ï¼Œè®¾ç½®è§¦å‘æ¡ä»¶ï¼Œä»¥åŠå®šä¹‰è¯·æ±‚çš„å†…å®¹å’Œæ ¼å¼ã€‚



![1689651530556](images/1689651530556.png)

![1689651554862](images/1689651554862.png)

------

### æµ‹è¯•æ•°æ®ï¼ˆpushï¼‰

**Request URL:** POST http://192.168.96.19:5000/git/webhook 200

**Trigger:** Push Hook

**Elapsed time:** 0.01 sec

**Request time:** åˆšåˆš

------

##### Request headers:

```
Content-Type: application/jsonX-Gitlab-Event: Push HookX-Gitlab-Token: asdhiqbryuwfqodwgeayrgfbsifbd
```

##### Request body:

```
{
  "object_kind": "push",
  "event_name": "push",
  "before": "95790bf891e76fee5e1747ab589903a6a1f80f22",
  "after": "da1560886d4f094c3e6c9ef40349f7d38b5d27d7",
  "ref": "refs/heads/master",
  "checkout_sha": "da1560886d4f094c3e6c9ef40349f7d38b5d27d7",
  "message": "Hello World",
  "user_id": 4,
  "user_name": "John Smith",
  "user_email": "john@example.com",
  "user_avatar": "https://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=8://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=80",
  "project_id": 15,
  "project": {
    "id": 15,
    "name": "gitlab",
    "description": "",
    "web_url": "http://test.example.com/gitlab/gitlab",
    "avatar_url": "https://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=8://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=80",
    "git_ssh_url": "git@test.example.com:gitlab/gitlab.git",
    "git_http_url": "http://test.example.com/gitlab/gitlab.git",
    "namespace": "gitlab",
    "visibility_level": 0,
    "path_with_namespace": "gitlab/gitlab",
    "default_branch": "master"
  },
  "commits": [
    {
      "id": "c5feabde2d8cd023215af4d2ceeb7a64839fc428",
      "message": "Add simple search to projects in public area",
      "timestamp": "2013-05-13T18:18:08+00:00",
      "url": "https://test.example.com/gitlab/gitlab/-/commit/c5feabde2d8cd023215af4d2ceeb7a64839fc428",
      "author": {
        "name": "Test User",
        "email": "test@example.com"
      }
    }
  ],
  "total_commits_count": 1,
  "push_options": {
    "ci": {
      "skip": true
    }
  }
}
```

##### Response headers:

```
Server: Werkzeug/2.3.6 Python/3.8.0Date: Tue, 18 Jul 2023 03:39:51 GMTContent-Type: application/jsonContent-Length: 26Connection: close
```

##### Response body:

```
{
  "status": "success"
}
```



## å®‰è£…è¿è¡Œ

### 1ã€ä¸‹è½½ä»£ç 

```python
git clone https://github.com/nangongchengfeng/chat-review.git
```

### 2ã€å®‰è£…ä¾èµ–

![1689663745702](images/1689663745702.png)

```python
python deal_package.py
```

### 3ã€æ›´æ–°é…ç½®

**config/config.py**

```python

"""
è¿™ä¸ªæ–‡ä»¶æ˜¯ç”¨æ¥ä»apolloé…ç½®ä¸­å¿ƒè·å–é…ç½®çš„ï¼Œ
å¦‚æœæ²¡æœ‰apolloé…ç½®ä¸­å¿ƒï¼Œå¯ä»¥ç›´æ¥åœ¨è¿™é‡Œé…ç½®
"""

WEBHOOK_VERIFY_TOKEN = "asdhiqbryuwfqodwgeayrgfbsifbd"
gitlab_server_url = gitlab_server_url
gitlab_private_token = gitlab_private_token
openai_api_key = openai_api_key

```

### 4ã€è¿è¡Œapp.pyæ–‡ä»¶

```python
ç®€å•
nohup python3 app.py & 
```





## ç–‘éš¾æ‚ç—‡

### diffå¤„ç†

![1689661104194](images/1689661104194.png)

#### æ–¹æ³•1 (ç®€æ´)

1ã€æŠŠè·å–diffçš„å†…å®¹å…¨éƒ¨ä¼ ç»™chatgptè¿›è¡Œå¤„ç†ï¼Œï¼ˆåŒ…å«æ·»åŠ è¡Œï¼Œåˆ é™¤è¡Œï¼‰

ä¼˜åŠ¿ï¼šæ–¹ä¾¿ï¼Œå¿«é€Ÿ

ç¼ºç‚¹ï¼šå¦‚æœå†…å®¹è¿‡é•¿ï¼Œå¯¼è‡´ChatGPTå¤„ç†å¤±è´¥ï¼Œåªæ˜¯éƒ¨åˆ†ä»£ç ï¼Œé€»è¾‘ä¸é€šé¡º



#### æ–¹æ³•2 (æ¨è)

2ã€æŠŠè·å–diffçš„å†…å®¹è¿›è¡Œå¤„ç†ï¼Œå–æ¶ˆåˆ é™¤è¡Œ å’Œ + å·æ ‡å¿—

ä¼˜åŠ¿ï¼šæ–¹ä¾¿ï¼Œå¿«é€Ÿï¼ŒèŠ‚çº¦ä¸€å®šé•¿åº¦

ç¼ºç‚¹ï¼šå¦‚æœå†…å®¹è¿‡é•¿ï¼Œå¯¼è‡´ChatGPTå¤„ç†å¤±è´¥ï¼Œåªæ˜¯éƒ¨åˆ†ä»£ç ï¼Œé€»è¾‘ä¸é€šé¡º

```python
def filter_diff_content(diff_content):
    filtered_content = re.sub(r'(^-.*\n)|(^@@.*\n)', '', diff_content, flags=re.MULTILINE)
    processed_code = '\n'.join([line[1:] if line.startswith('+') else line for line in filtered_content.split('\n')])
    return processed_code
```

![1689661743140](images/1689661743140.png)



#### æ–¹æ³•3 (å¤æ‚)

3ã€æŠŠdiff çš„å†…å®¹è¿›è¡Œå¤„ç†ï¼Œå–æ¶ˆåˆ é™¤è¡Œ å’Œ + å·æ ‡å¿—ï¼Œè·å–å·²ç»ä¿®æ”¹çš„åŸæ–‡ä»¶ï¼Œä½¿ç”¨JavaParserè¿›è¡Œè§£æã€‚è·å–åˆ°ç›¸åº”çš„ä»£ç å—ï¼Œè¿›è¡Œä¸Šä¼ review

ä¼˜åŠ¿ï¼šèŠ‚çº¦é•¿åº¦ï¼Œæ–¹æ³•å®Œæˆï¼Œé€»è¾‘ç¨å¾®é€šé¡º

ç¼ºç‚¹ï¼šååˆ†çš„éº»çƒ¦ï¼Œç¹çï¼Œä»…æ”¯æŒJava

```json
[{
	'code': 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
	'name': 'SettlementDetailController'
}, {
	'code': 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
	'name': 'queryRecord'
}, {
	'code': 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
	'name': 'populateBatchItemVO'
}]
```



## æ¼”ç¤ºå›¾

![1689663598079](images/1689663598079.png)























